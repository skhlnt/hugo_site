{{- define "main" }}

<article class="post-single">
  <header class="page-header">
    <!-- {{ partial "breadcrumbs.html" . }} -->
    <h1>{{ .Title }}</h1>
    {{- if .Description }}
    <div class="post-description">{{ .Description }}</div>
    {{- end }}
  </header>

  {{- if .Content }}
  <div class="post-content">{{ .Content }}</div>
  {{- end }}

  <div class="gallery-grid">
    {{- range .Site.Data.gallery }}
    <div class="gallery-item" 
         data-type="{{ .type }}" 
         data-src="{{ .image }}"
         data-title="{{ .title }}"
         {{- if eq .type "map" }}
         data-tiles="{{ .tiles }}"
         data-width="{{ .width }}"
         data-height="{{ .height }}"
         data-maxzoom="{{ .maxZoom }}"
         {{- end }}>
      <img src="{{ .thumbnail | default .image }}" alt="{{ .title }}" loading="lazy">
      <div class="gallery-item-title">{{ .title }}</div>
      {{- if eq .type "map" }}
      <span class="gallery-item-badge">üó∫Ô∏è Âú∞Âõæ</span>
      {{- end }}
    </div>
    {{- end }}
  </div>
</article>

<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Êü•ÁúãÂô®Ê®°ÊÄÅÊ°Ü -->
<div id="gallery-modal" class="gallery-modal">
  <div class="gallery-modal-header">
    <span class="gallery-modal-title"></span>
    <button class="gallery-modal-close">&times;</button>
  </div>
  <div class="gallery-modal-content">
    <div id="image-viewer" class="image-viewer">
      <img src="" alt="">
    </div>
    <div id="map-viewer" class="map-viewer">
      <div id="map-container"></div>
    </div>
  </div>
</div>

<style>
.gallery-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 20px;
  margin-top: 30px;
}

.gallery-item {
  position: relative;
  cursor: pointer;
  border-radius: 8px;
  overflow: hidden;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  background: var(--entry);
  border: 1px solid var(--border);
}

.gallery-item:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
}

.gallery-item img {
  width: 100%;
  height: 200px;
  object-fit: cover;
  display: block;
}

.gallery-item-title {
  padding: 12px;
  font-size: 14px;
  color: var(--content);
}

.gallery-item-badge {
  position: absolute;
  top: 10px;
  right: 10px;
  background: rgba(0, 0, 0, 0.7);
  color: white;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
}

.gallery-modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.95);
}

.gallery-modal.active {
  display: block;
}

.gallery-modal-header {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  background: linear-gradient(to bottom, rgba(0, 0, 0, 0.8), transparent);
  z-index: 1001;
}

.gallery-modal-title {
  color: white;
  font-size: 18px;
  font-weight: 500;
}

.gallery-modal-close {
  background: none;
  border: none;
  color: white;
  font-size: 40px;
  cursor: pointer;
  line-height: 1;
  padding: 0;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.2s;
}

.gallery-modal-close:hover {
  transform: scale(1.2);
}

.gallery-modal-content {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.image-viewer {
  display: none;
  width: 100%;
  height: 100%;
  align-items: center;
  justify-content: center;
  padding: 80px 20px 20px;
}

.image-viewer.active {
  display: flex;
}

.image-viewer img {
  max-width: 90%;
  max-height: 90%;
  object-fit: contain;
}

.map-viewer {
  display: none;
  width: 100%;
  height: 100%;
  padding: 80px 20px 20px;
}

.map-viewer.active {
  display: block;
}

#map-container {
  width: 100%;
  height: 100%;
  background: #1a1a1a;
  min-height: 500px;  /* Ê∑ªÂä†ËøôË°åÔºåÁ°Æ‰øùÊúâÊúÄÂ∞èÈ´òÂ∫¶ */
}

.leaflet-container {
  background: #1a1a1a;
  font-family: inherit;
}

@media (max-width: 768px) {
  .gallery-grid {
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 15px;
  }
  .gallery-item img {
    height: 150px;
  }
}
</style>

<script>
(function() {
  const modal = document.getElementById('gallery-modal');
  const imageViewer = document.getElementById('image-viewer');
  const mapViewer = document.getElementById('map-viewer');
  const modalTitle = document.querySelector('.gallery-modal-title');
  const closeBtn = document.querySelector('.gallery-modal-close');
  const galleryItems = document.querySelectorAll('.gallery-item');
  
  let currentMap = null;

  // ÁÇπÂáªÂõæÁâáÈ°πÊâìÂºÄÊü•ÁúãÂô®
  galleryItems.forEach(item => {
    item.addEventListener('click', function() {
      const type = this.dataset.type;
      const src = this.dataset.src;
      const title = this.dataset.title;

      modalTitle.textContent = title;
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';

      if (type === 'map') {
        imageViewer.classList.remove('active');
        mapViewer.classList.add('active');
        
        const tiles = this.dataset.tiles;
        const width = parseInt(this.dataset.width) || 10000;
        const height = parseInt(this.dataset.height) || 10000;
        const maxZoom = parseInt(this.dataset.maxzoom) || 5;
        
        initMap(tiles, width, height, maxZoom);
      } else {
        mapViewer.classList.remove('active');
        imageViewer.classList.add('active');
        imageViewer.querySelector('img').src = src;
      }
    });
  });

 // ÂàùÂßãÂåñÂú∞ÂõæÊü•ÁúãÂô®
function initMap(tilesUrl, width, height, maxZoom) {
  if (currentMap) {
    currentMap.remove();
    currentMap = null;
  }
  const map = L.map('map-container', {
    crs: L.CRS.Simple,
    minZoom: 0,
    maxZoom,
    zoomControl: true,
    attributionControl: false,
    maxBoundsViscosity: 1
  });

  const southWest = map.unproject([0, height], maxZoom);
  const northEast = map.unproject([width, 0], maxZoom);
  const bounds = new L.LatLngBounds(southWest, northEast);

  L.tileLayer(tilesUrl, {
    minZoom: 0,
    maxZoom,
    maxNativeZoom: maxZoom,
    tileSize: 256,
    tms: true,
    bounds,
    noWrap: true
  }).addTo(map);

  map.fitBounds(bounds);
  map.setMaxBounds(bounds);
  currentMap = map;
  requestAnimationFrame(() => currentMap.invalidateSize());
}

  // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
  function closeModal() {
    modal.classList.remove('active');
    document.body.style.overflow = '';
    
    if (currentMap) {
      currentMap.remove();
      currentMap = null;
    }
    
    imageViewer.querySelector('img').src = '';
  }

  closeBtn.addEventListener('click', closeModal);
  
  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      closeModal();
    }
  });

  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && modal.classList.contains('active')) {
      closeModal();
    }
  });
})();
</script>

{{- end }}